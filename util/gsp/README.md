# gdbserver-profiler - gsp

`gsp` is a profiling toolchain connecting to a gdbserver via UNIX socket or
TCP/IPv6. After reaching the start symbol (default: entry of provided image),
the tracer `gsp-trace` single steps through the program, until the stop symbol
is reached (default: never stops automatically).

The resulting trace file contains addresses for every executed instruction and
can be converted to a symbolized trace file in the following format with
`gsp-syms`.

```
_start
_start(+0x2)
main
main(+0x1)
main(+0x2)
main(+0x6)
...

```

Now, to have a visualized version of this, you can use `gsp-stackcollapse` to
convert the symbolized trace file to a stack trace file compatible with
[FlameGraph](https://github.com/brendangregg/FlameGraph).

## Docs

### `gsp-trace`

Trace a program and write a trace file

```
Usage: ./gsp-trace -hc -i program.elf [ -o /dev/stdout ] [ -g localhost:1234 ]

Parameters
   -i $image_file   Compiled program to read for symbols
   -o $output_file  Where to write the trace, defaults to /dev/stdout
   -g $gdbserver    Where to reach the gdbserver, defaults to localhost:1234
   -s $start_symbol Where to start profiling (defaults to entry point of image)
   -S $stop_symbol  Where to stop profiling (defaults to never)

Flags
   -h               Give this help and exit with status -1
   -c               Issue continue to gdbserver after initialization
```

### `gsp-syms`

Convert trace file generated by `gsp-trace` to a symbolized trace file

```
Usage: ./gsp-syms -h -i program.elf -t program.trace [ -o program.trace.syms ]

Parameters
   -i $image_file   Compiled program to read for symbols
   -t $trace_file   File created by gsp-trace
   -o $output_file  Where to write the trace with symbols, defaults to $trace_file.syms

Flags
   -h               Give this help and exit with status -1
```

### `gsp-stackcollapse.pl`

Convert symbolized trace file to FlameGraph compatible stack trace

```
cat lf_os.trace.symbolized | ./gsp-stackcollapse.pl > lf_os.trace.stack
```

## Restrictions

* only ELF64 images are supported right now
* debug symbols must be present
* bad things will happen if you run other code than the image you give to the
  gsp tools
* image cannot be relocated

## Use case

This toolchain can be used to profile low-level code running on QEMU. The tracer
connects to the gdbserver built into qemu in this case (`qemu-system-x86_64 -s`)
and single steps through the code after the start of the image is reached.

**Beware**: QEMU user interfaces update the window title when the VM state
changes. Single stepping changes the VM state very often and the title is
updated twice for every single instruction executed after the start symbol. This
bubbles through X server to your window manager and maybe even your compositor.
My work computer (Thinkpad P52, 16GB RAM, i7-8850H (6 cores + HT)) was barely
usable while the profiling was running.

## License

gsp
Copyright (C) 2019  Mara Sophie Grosch

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
