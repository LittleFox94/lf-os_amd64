# vim: ft=make

src_dir := $(dir $(realpath $(firstword $(MAKEFILE_LIST))))

all: libc.a crt1.o crti.o crtn.o

libc.a: $(src_dir)../newlib/build/Makefile
	+ make -C $(src_dir)../newlib/build
	+ make -C $(src_dir)../newlib/build install
	cp -r $(src_dir)../../sysroot/x86_64-lf_os-elf/* $(src_dir)../../sysroot
	rm -rf $(src_dir)../../sysroot/x86_64-lf_os-elf

crti.o: $(src_dir)lib/crti.S
	clang -g -c $< -o $@

crtn.o: $(src_dir)lib/crtn.S
	clang -g -c $< -o $@

crt1.o: $(src_dir)lib/crt1.S
	clang -g -c $< -o $@

$(src_dir)../newlib/build:
	mkdir -p $@

$(src_dir)../newlib/build/Makefile: $(src_dir)../newlib/build crti.o crtn.o
	cd $(src_dir)../newlib/build && \
	CC_FOR_TARGET=clang \
	LD_FOR_TARGET=ld.lld  \
	CXX_FOR_TARGET=clang++ \
	AR_FOR_TARGET=ar \
	AS_FOR_TARGET=clang \
	RANLIB_FOR_TARGET=ranlib \
	READELF_FOR_TARGET=readelf \
	OBJCOPY_FOR_TARGET=objcopy \
	OBJDUMP_FOR_TARGET=objdump \
	STRIP_FOR_TARGET=strip \
	CFLAGS_FOR_TARGET="$(CFLAGS) -D__GLIBC_USE\(...\)=0 $(OPTIMIZATION) -fuse-init-array" \
	../configure --target x86_64-lf_os-elf --disable-multilib --prefix $(src_dir)../../sysroot

clean:
	rm -rf $(src_dir)../newlib/build
	rm -f crti.o crtn.o crt1.o

.PHONY: clean
