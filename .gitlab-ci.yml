stages:
- prepare-toolchain
- build-toolchain
- deploy-toolchain
- prepare
- test
- build
- deploy

variables:
  VERSION: 0.1.1+${CI_PIPELINE_ID}

.docker-build: &docker-build
  image:
    name: gcr.io/kaniko-project/executor:debug-edge
    entrypoint: [""]
  script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - >-
        /kaniko/executor
        --context     $CI_PROJECT_DIR
        --dockerfile  $CI_PROJECT_DIR/$DOCKERFILE
        --destination $IMAGE_NAME:$IMAGE_TAG
        --destination $IMAGE_NAME/$CI_COMMIT_REF_NAME:latest
        --cache=true
        --cache-repo $CI_REGISTRY_IMAGE/$CI_COMMIT_REF_NAME/kaniko-cache
  only:
  - branches

ci-image-llvm:
  <<: *docker-build
  stage: prepare-toolchain
  variables:
    IMAGE_NAME: $CI_REGISTRY_IMAGE/llvm-ci
    IMAGE_TAG:  $CI_COMMIT_SHA
    DOCKERFILE: Dockerfile.llvm-ci

llvm:
  stage: build-toolchain
  interruptible: true
  needs:
  - ci-image-llvm
  image: $CI_REGISTRY_IMAGE/llvm-ci:$CI_COMMIT_SHA
  variables:
    GIT_STRATEGY: fetch
    GIT_SUBMODULE_STRATEGY: recursive
    ARTIFACT_COMPRESSION_LEVEL: fastest
  script:
  - mkdir build && cd build
  - cmake -DPACKAGE_VERSION=$VERSION -DCMAKE_BUILD_TYPE=Release -G Ninja -Dsubproject=toolchain ..
  - ninja
  - cpack
  - mv lf_os-toolchain.tar.xz               ../lf_os-toolchain_${VERSION}_amd64.tar.xz
  - mv lf_os-toolchain_${VERSION}_amd64.deb ../
  artifacts:
    paths:
    - "lf_os-toolchain_${VERSION}_amd64.tar.xz"
    - "lf_os-toolchain_${VERSION}_amd64.deb"
  only:
    changes:
    - cmake/project_toolchain.cmake
    - CMakeLists.txt
    - .gitlab-ci.yml
    - src/llvm
    - Dockerfile.ci

llvm-deploy:
  stage: deploy-toolchain
  image: alpine
  variables:
    GIT_STRATEGY: none
  before_script:
  - apk add -u --no-cache curl
  script:
  - |
    for package in *.deb; do
      curl -X PUT --data-binary @$package -f        \
      -H 'Content-Type: application/octet-stream'   \
      -H 'x-component: lf-os'                       \
      -H 'x-suites: unstable'                        \
      -H "Authorization: Bearer $APT_DEPLOY_TOKEN"  \
      https://fission.svc.0x0a.network/apt/upload
    done
  only:
    refs:
    - master
    changes:
    - cmake/project_toolchain.cmake
    - CMakeLists.txt
    - .gitlab-ci.yml
    - src/llvm
    - Dockerfile.ci
  needs:
  - llvm

llvm-deploy:
  stage: deploy-toolchain
  image: alpine
  variables:
    GIT_STRATEGY: none
  before_script:
  - apk add -u --no-cache curl
  script:
  - |
    for package in *.deb; do
      curl -X PUT --data-binary @$package -f        \
      -H 'Content-Type: application/octet-stream'   \
      -H 'x-component: lf-os'                       \
      -H 'x-suites: unstable'                        \
      -H "Authorization: Bearer $APT_DEPLOY_TOKEN"  \
      https://fission.svc.0x0a.network/apt/upload
    done
  only:
    refs:
    - master
    changes:
    - cmake/project_toolchain.cmake
    - CMakeLists.txt
    - .gitlab-ci.yml
    - src/llvm
  needs:
  - llvm

ci-image:
  <<: *docker-build
  stage: prepare
  variables:
    IMAGE_NAME: $CI_REGISTRY_IMAGE/ci
    IMAGE_TAG:  $CI_COMMIT_SHA
    DOCKERFILE: Dockerfile.ci
  only:
    changes:
    - cmake/project_toolchain.cmake
    - CMakeLists.txt
    - .gitlab-ci.yml
    - src/llvm
    - Dockerfile.ci
  needs:
  - llvm

test:
  stage: test
  image: $CI_REGISTRY_IMAGE/ci/$CI_COMMIT_REF_NAME:latest
  variables:
    CTEST_OUTPUT_ON_FAILURE: "1"
    GIT_STRATEGY: fetch
  script:
  - cmake -DCMAKE_BUILD_TYPE=Release -G Ninja -B build -S .
  - ninja -C build test-kernel
  only:
    changes:
    - src/**/*
    - cmake/**/*
    - CMakeLists.txt
    - .gitlab-ci.yml
    - Dockerfile.ci

build:
  stage: build
  image: $CI_REGISTRY_IMAGE/ci/$CI_COMMIT_REF_NAME:latest
  interruptible: true
  before_script:
  - '[ -z "$CCACHE_DIR" ] && export CCACHE_DIR=$(pwd)/.ccache'
  script:
  - cmake -G Ninja -DCPACK_PACKAGE_VERSION=0.1.1-${CI_PIPELINE_IID} -DCMAKE_BUILD_TYPE=Release -B build -S .
  - ninja -C build -j$(nproc) hd.img.xz package
  - mv build/hd.img.xz build/*.deb .
  variables:
    GIT_STRATEGY: fetch
    GIT_SUBMODULE_STRATEGY: recursive
    ARTIFACT_COMPRESSION_LEVEL: fastest
  artifacts:
    paths:
    - hd.img.xz
    - "*.deb"
  cache:
    paths:
    - .ccache
  only:
    changes:
    - src/**/*
    - cmake/**/*
    - CMakeLists.txt
    - .gitlab-ci.yml
    - Dockerfile.ci

deploy-apt:
  stage: deploy
  image: alpine
  variables:
    GIT_STRATEGY: none
  before_script:
  - apk add -u --no-cache curl
  script:
  - |
    for package in *.deb; do
      curl -X PUT --data-binary @$package -f        \
      -H 'Content-Type: application/octet-stream'   \
      -H 'x-component: lf-os'                       \
      -H 'x-suites: unstable'                        \
      -H "Authorization: Bearer $APT_DEPLOY_TOKEN"  \
      https://fission.svc.0x0a.network/apt/upload
    done
  only:
    refs:
    - master
    changes:
    - src/**/*
    - cmake/**/*
    - CMakeLists.txt
    - .gitlab-ci.yml
    - Dockerfile.ci
  needs:
  - build

pages:
  stage: deploy
  image: $CI_REGISTRY_IMAGE/ci/$CI_COMMIT_REF_NAME:latest
  variables:
    GIT_STRATEGY: fetch
    ARTIFACT_COMPRESSION_LEVEL: fastest
  script:
  - cmake -DCMAKE_BUILD_TYPE=Release -G Ninja -B build -S .
  - ninja -C build doc
  - mv build/doc/html public
  artifacts:
    paths:
    - public
  only:
    refs:
    - master
