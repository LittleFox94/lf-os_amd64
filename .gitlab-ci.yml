stages:
- test
- build
- pages

default:
  image: registry.lf-net.org/littlefox/lf-os_amd64/ci:2020100601

test:
  stage: test
  variables:
    CFLAGS:   -fuse-ld=lld
    CXXFLAGS: -fuse-ld=lld
  script:
  - cmake -DCMAKE_BUILD_TYPE=Release -B build -S .
  - make -C build test-kernel

build:
  stage: build
  interruptible: true
  script:
  - cmake -DCMAKE_BUILD_TYPE=Release -B build -S .
  - make -C build -j$(($(nproc) / 2)) hd.img
  after_script:
  - mv build/hd.img hd.img
  variables:
    GIT_SUBMODULE_STRATEGY: recursive
    CFLAGS:   -fuse-ld=lld
    CXXFLAGS: -fuse-ld=lld
  cache:
    paths:
    - build
  artifacts:
    paths:
    - hd.img

#pages:
#  stage: pages
#  script:
#    - make doc
#    - mv doc/doxygen/html ../public
#  artifacts:
#    paths:
#    - public
#  only:
#  - master
