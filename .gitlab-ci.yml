stages:
- test
- build
- deploy

default:
  image: registry.lf-net.org/littlefox/lf-os_amd64/ci:2021032201

test:
  stage: test
  variables:
    CTEST_OUTPUT_ON_FAILURE: "1"
  script:
  - cmake -DCMAKE_BUILD_TYPE=Release -B build -S .
  - make -C build test-kernel

build:
  stage: build
  interruptible: true
  script:
  - cmake -DCPACK_PACKAGE_VERSION=0.1.1-${CI_PIPELINE_IID} -DCMAKE_BUILD_TYPE=Release -B build -S .
  - make -C build -j$(nproc) hd.img.xz package
  - mv build/hd.img.xz build/*.deb .
  cache:
    key: ${CI_COMMIT_REF_SLUG} # cache per branch ..
    paths:
    - build
  variables:
    GIT_SUBMODULE_STRATEGY: recursive
    CACHE_FALLBACK_KEY: master # .. but fallback to use cache from master branch
  artifacts:
    paths:
    - hd.img.xz
    - "*.deb"
    - toolchain/include/kernel/syscalls.h

deploy-apt:
  stage: deploy
  image: alpine
  variables:
    GIT_STRATEGY: none
  before_script:
  - apk add -u --no-cache curl
  script:
  - |
    for package in *.deb; do
      curl -X PUT --data-binary @$package           \
      -H 'x-component: lf-os'                       \
      -H 'x-suite: unstable'                        \
      -H "Authorization: Bearer $APT_DEPLOY_TOKEN"  \
      https://fission.svc.0x0a.network/apt/upload
    done
  only:
  - master
  dependencies:
  - build

pages:
  stage: deploy
  cache: {}
  script:
  - cmake -DCMAKE_BUILD_TYPE=Release -B build -S .
  - make -C build doc
  - mv build/doc/html public
  artifacts:
    paths:
    - public
  only:
  - master
  dependencies:
  - build
